// Copyright (c) 2026 delfineonx, TenderGalaxy
// This product includes "Runtime Tester" created by delfineonx, TenderGalaxy.
// Licensed under the Apache License, Version 2.0.

{
  const _RT={
    set func_A(fn){_func_A=fn},
    get func_A(){return _func_A},
    set func_B(fn){_func_B=fn},
    get func_B(){return _func_B},
    samples_A:null,
    samples_B:null,
    styles:[
      "#FF775E","500","0.95rem",
      "#FFC23D","500","0.95rem",
      "#20DD69","500","0.95rem",
      "#52B2FF","500","0.95rem"
    ],
    __init__:null,
    start:null,
    pause:null,
    resume:null,
    last_samples:null,
    stats_light:null,
    tick_light:null,
    stats_heavy:null,
    tick_heavy:null
  };

  const _eval=eval;const _no_op=()=>{};let _tick_step=.5;let _base_step=0;let _bench_step_A=1;let _save_step_A=2;let _bench_step_B=4;let _save_step_B=5;let _work_quota_A=10;let _work_quota_B=0;let _iterations_count=0;let _func_A=_no_op;let _runs_A=0;let _last_sample_A=0;const _samples_A=_RT.samples_A=[];let _func_B=_no_op;let _runs_B=0;let _last_sample_B=0;const _samples_B=_RT.samples_B=[];const _task_queue=[];let _tasks_count=0;let _task_index=0;let _task_phase_1=1;let _task_phase_2=1;const _process_queue=()=>{let is_active=_task_index<_tasks_count;while(is_active){try{if(!_task_queue[_task_index]()){break}}catch(error){_task_phase_1=_task_phase_2=1;_log("Runtime Tester: Analysis error - "+error.name+": "+error.message,0)}is_active=++_task_index<_tasks_count}if(!is_active){_task_index=0;_tasks_count=_task_queue.length=0}};
  {
    const _STYLES=[];const _broadcastMessage=api.broadcastMessage;const _log=(message,type)=>{const styledText=_STYLES[type];styledText[0].str=message;_broadcastMessage(styledText);styledText[0].str=""};const _baseline_iteration_tu=4;let _tu_scale=8e4;let _index=0;let _samples_count=0;let _median_raw=0;const _abs_deviations_buffer=[];let _median_abs_deviation=0;let _lower_cutoff=0;let _upper_cutoff=0;let _start_index=0;let _end_index=-1;let _samples_used=0;let _sum_filtered=0;let _iterations_end_index=0;let _iterations_start_index=0;let _iterations_A=null;let _iterations_B=null;let _runtime_samples_A=null;let _runtime_samples_B=null;let _runtime_A=null;let _runtime_B=null;let _iterations_samples_used=0;let _pairs_used=0;let _spent_iterations_samples_A=null;let _effective_iterations_samples_A=null;let _effective_runtime_samples_A=null;let _spent_iterations_A=null;let _effective_iterations_A=null;let _effective_runtime_A=null;const _median_of_range=(sorted_samples,start_index,end_index)=>{const samples_used=end_index-start_index+1;const mid=start_index+(samples_used>>1);return samples_used&1?sorted_samples[mid]:(sorted_samples[mid-1]+sorted_samples[mid])*.5};const _analyze_distribution=(samples,mad_multiplier,is_sorted)=>{if(_task_phase_2===1){_samples_count=samples.length;if(!_samples_count){_task_phase_2=1;return{mean:0,median:0,used:0,mad:0,lower:0,upper:0,sorted:samples,start:0,end:-1}}if(!is_sorted){samples.sort((a,b)=>a-b)}_median_raw=_median_of_range(samples,0,_samples_count-1);_abs_deviations_buffer.length=_samples_count;_index=0;_task_phase_2=2}if(_task_phase_2===2){let diff;while(_index<_samples_count){diff=samples[_index]-_median_raw;_abs_deviations_buffer[_index]=diff<0?-diff:diff;_index++}_abs_deviations_buffer.sort((a,b)=>a-b);_median_abs_deviation=_median_of_range(_abs_deviations_buffer,0,_samples_count-1)||1;_lower_cutoff=_median_raw-mad_multiplier*_median_abs_deviation;_upper_cutoff=_median_raw+mad_multiplier*_median_abs_deviation;_abs_deviations_buffer.length=0;_start_index=0;_end_index=_samples_count-1;_samples_used=0;_sum_filtered=0;_index=0;_task_phase_2=3}if(_task_phase_2===3){while(samples[_start_index]<_lower_cutoff){_start_index++}while(samples[_end_index]>_upper_cutoff){_end_index--}_samples_used=_end_index-_start_index+1;_index=_start_index;_task_phase_2=4}if(_task_phase_2===4){while(_index<=_end_index){_sum_filtered+=samples[_index];_index++}const mean_filtered=_sum_filtered/_samples_used;const median_filtered=_median_of_range(samples,_start_index,_end_index);_task_phase_2=1;return{mean:mean_filtered,median:median_filtered,used:_samples_used,mad:_median_abs_deviation,lower:_lower_cutoff,upper:_upper_cutoff,sorted:samples,start:_start_index,end:_end_index}}};const _make_runtime_samples=(distribution,output)=>{if(_task_phase_2===1){_index=0;_iterations_end_index=distribution.end;_iterations_start_index=distribution.start;output.length=distribution.used;_task_phase_2=2}if(_task_phase_2===2){const sorted_samples=distribution.sorted;while(_iterations_end_index>=_iterations_start_index){output[_index]=_tu_scale/(sorted_samples[_iterations_end_index]||1);_index++;_iterations_end_index--}_task_phase_2=1}};const _round_to_2=num=>Math.round(num*100)/100;const _round_to_4=num=>Math.round(num*1e4)/1e4;const _format_block_runtime=(name,total_runs,iterations_dist,runtime_dist)=>"[ "+name+" ] "+(total_runs?"(runs = "+total_runs+")":"")+"\n  iterations mean = "+_round_to_4(iterations_dist.mean)+" | median = "+_round_to_4(iterations_dist.median)+" | used = "+iterations_dist.used+"\n  mad = "+_round_to_4(iterations_dist.mad)+" | range = ["+_round_to_4(iterations_dist.lower)+" .. "+_round_to_4(iterations_dist.upper)+"]"+"\n  TU mean = "+_round_to_2(runtime_dist.mean)+" | median = "+_round_to_2(runtime_dist.median)+" | used = "+runtime_dist.used+"\n  mad = "+_round_to_2(runtime_dist.mad)+" | range = ["+_round_to_2(runtime_dist.lower)+" .. "+_round_to_2(runtime_dist.upper)+"]";const _format_block_iterations=(name,total_runs,iterations_dist)=>"[ "+name+" ] "+(total_runs?"(runs = "+total_runs+")":"")+"\n  iterations mean = "+_round_to_4(iterations_dist.mean)+" | median = "+_round_to_4(iterations_dist.median)+" | used = "+iterations_dist.used+"\n  mad = "+_round_to_4(iterations_dist.mad)+" | range = ["+_round_to_4(iterations_dist.lower)+" .. "+_round_to_4(iterations_dist.upper)+"]";const _stats_light_task=(mad_multiplier,output,show_logs)=>{if(_task_phase_1===1){_iterations_A=_analyze_distribution(_samples_A,mad_multiplier,false);_runtime_samples_A=[];_task_phase_1=2}if(_task_phase_1===2){_iterations_B=_analyze_distribution(_samples_B,mad_multiplier,false);_tu_scale=(_iterations_B.median||1)*_baseline_iteration_tu;_runtime_samples_B=[];_task_phase_1=3}if(_task_phase_1===3){_make_runtime_samples(_iterations_A,_runtime_samples_A);_task_phase_1=4}if(_task_phase_1===4){_make_runtime_samples(_iterations_B,_runtime_samples_B);_task_phase_1=5}if(_task_phase_1===5){_runtime_A=_analyze_distribution(_runtime_samples_A,mad_multiplier,true);_task_phase_1=6}if(_task_phase_1===6){_runtime_B=_analyze_distribution(_runtime_samples_B,mad_multiplier,true);_task_phase_1=7}if(_task_phase_1===7){if(output!=null){output.iterations_A=_iterations_A;output.iterations_B=_iterations_B;output.runtime_A=_runtime_A;output.runtime_B=_runtime_B}if(show_logs){_log(_format_block_runtime("func A",_runs_A,_iterations_A,_runtime_A)+"\n\n"+_format_block_runtime("func B",_runs_B,_iterations_B,_runtime_B),3)}_runtime_samples_A=null;_runtime_samples_B=null;_iterations_A=null;_iterations_B=null;_runtime_A=null;_runtime_B=null;_task_phase_1=1;return true}};const _stats_heavy_task=(mad_multiplier,output,show_logs)=>{if(_task_phase_1===1){_iterations_A=_analyze_distribution(_samples_A,mad_multiplier,false);_task_phase_1=2}if(_task_phase_1===2){_iterations_B=_analyze_distribution(_samples_B,mad_multiplier,false);_task_phase_1=3}if(_task_phase_1===3){_iterations_samples_used=_iterations_A.used<_iterations_B.used?_iterations_A.used:_iterations_B.used;_spent_iterations_samples_A=[];_effective_iterations_samples_A=[];_effective_runtime_samples_A=[];_pairs_used=0;_index=0;_task_phase_1=4}if(_task_phase_1===4){const sorted_samples_A=_iterations_A.sorted;const sorted_samples_B=_iterations_B.sorted;const start_index_A=_iterations_A.start;const start_index_B=_iterations_B.start;let remainder_A,remainder_B,spent;while(_index<_iterations_samples_used){remainder_A=sorted_samples_A[start_index_A+_index];remainder_B=sorted_samples_B[start_index_B+_index];spent=remainder_B-remainder_A;if(spent>0){_spent_iterations_samples_A[_pairs_used]=spent;_effective_iterations_samples_A[_pairs_used]=remainder_B*_work_quota_A/spent;_pairs_used++}_index++}_spent_iterations_samples_A.length=_pairs_used;_effective_iterations_samples_A.length=_pairs_used;_task_phase_1=5}if(_task_phase_1===5){_spent_iterations_A=_analyze_distribution(_spent_iterations_samples_A,mad_multiplier,false);_task_phase_1=6}if(_task_phase_1===6){_effective_iterations_A=_analyze_distribution(_effective_iterations_samples_A,mad_multiplier,false);_tu_scale=(_iterations_B.median||1)*_baseline_iteration_tu;_task_phase_1=7}if(_task_phase_1===7){_make_runtime_samples(_effective_iterations_A,_effective_runtime_samples_A),_task_phase_1=8}if(_task_phase_1===8){_effective_runtime_A=_analyze_distribution(_effective_runtime_samples_A,mad_multiplier,true);_task_phase_1=9}if(_task_phase_1===9){if(output!=null){output.iterations_A=_iterations_A;output.iterations_B=_iterations_B;output.spent_iterations_A=_spent_iterations_A;output.effective_iterations_A=_effective_iterations_A;output.effective_runtime_A=_effective_runtime_A}if(show_logs){_log("work_A = "+_work_quota_A+" | work_B = "+_work_quota_B+"\n\n"+_format_block_iterations("func A",_runs_A,_iterations_A)+"\n\n"+_format_block_iterations("func B",_runs_B,_iterations_B)+"\n\n"+_format_block_iterations("spent (B - A)",0,_spent_iterations_A)+"\n  pairs = ("+_pairs_used+" / "+_iterations_samples_used+")"+"\n\n"+_format_block_runtime("effective (A)",_pairs_used,_effective_iterations_A,_effective_runtime_A),3)}_spent_iterations_samples_A=null;_effective_iterations_samples_A=null;_effective_runtime_samples_A=null;_iterations_A=null;_iterations_B=null;_spent_iterations_A=null;_effective_iterations_A=null;_effective_runtime_A=null;_task_phase_1=1;return true}};_RT.stats_light=(mad_multiplier=3,output=null,show_logs=true)=>{_task_queue[_task_queue.length]=()=>_stats_light_task(mad_multiplier,output,show_logs)};_RT.stats_heavy=(mad_multiplier=3,output=null,show_logs=true)=>{_task_queue[_task_queue.length]=()=>_stats_heavy_task(mad_multiplier,output,show_logs)};_RT.__init__=()=>{const logStyles=_RT.styles;for(let type=0;type<4;type++){_STYLES[type]=[{str:"",style:{color:logStyles[type*3],fontWeight:logStyles[type*3+1],fontSize:logStyles[type*3+2]}}]}};_RT.start=(bench_point_A=2,bench_point_B=6,work_quota_A=10,work_quota_B=0)=>{_save_step_A=1+(_bench_step_A=bench_point_A|0);_save_step_B=1+(_bench_step_B=bench_point_B|0);_work_quota_A=work_quota_A|0||1;_work_quota_B=work_quota_B|0;_iterations_count=0;_runs_A=_last_sample_A=0;_samples_A.length=0;_runs_B=_last_sample_B=0;_samples_B.length=0;_tick_step=_base_step=0;_task_queue.length=0;_tasks_count=0;_task_index=0;_task_phase_1=1;_task_phase_2=1;_abs_deviations_buffer.length=0;_iterations_A=null;_iterations_B=null;_runtime_samples_A=null;_runtime_samples_B=null;_runtime_A=null;_runtime_B=null;_spent_iterations_samples_A=null;_effective_iterations_samples_A=null;_effective_runtime_samples_A=null;_spent_iterations_A=null;_effective_iterations_A=null;_effective_runtime_A=null};_RT.pause=()=>{_base_step=.5};_RT.resume=()=>{if(_tick_step!==(_tick_step|0)){_tick_step=_base_step=0}};_RT.last_samples=(return_type=false)=>{if(return_type){return[_runs_A,_last_sample_A,_runs_B,_last_sample_B]}return"[ last samples ] (step = "+_tick_step+")"+"\n  runs_A = "+_runs_A+" | sample_A = "+_last_sample_A+"\n  runs_B = "+_runs_B+" | sample_B = "+_last_sample_B}
  }
  _RT.tick_light=()=>{if(_tick_step===_bench_step_A){_tick_step++;_iterations_count=0;while(true){_eval();_func_A();_iterations_count++}}if(_tick_step===_bench_step_B){_tick_step++;_iterations_count=0;while(true){_eval();_func_B();_iterations_count++}}if(_tick_step===_save_step_A){_samples_A[_runs_A++]=_last_sample_A=_iterations_count;_tick_step++;return}if(_tick_step===_save_step_B){_samples_B[_runs_B++]=_last_sample_B=_iterations_count;_tick_step=_base_step;return}_tick_step++;if(_tasks_count=_task_queue.length){_process_queue()}};
  _RT.tick_heavy=()=>{if(_tick_step===_bench_step_A){let _work_count=0;_tick_step++;_iterations_count=0;while(_work_count<_work_quota_A){_eval();_func_A();_work_count++}while(true){_eval();_no_op();_iterations_count++}}if(_tick_step===_bench_step_B){let _work_count=0;_tick_step++;_iterations_count=0;while(_work_count<_work_quota_B){_eval();_func_B();_work_count++}while(true){_eval();_no_op();_iterations_count++}}if(_tick_step===_save_step_A){_samples_A[_runs_A++]=_last_sample_A=_iterations_count;_tick_step++;return}if(_tick_step===_save_step_B){_samples_B[_runs_B++]=_last_sample_B=_iterations_count;_tick_step=_base_step;return}_tick_step++;if(_tasks_count=_task_queue.length){_process_queue()}};

  Object.freeze(_RT);
  globalThis.RT=_RT;
  _RT.__init__()
}

const _RT_tick = RT.tick_light;
// const _RT_tick = RT.tick_heavy;
tick = () => {
  _RT_tick();
};
